version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Build&Deploy
    task:
      jobs:
        - name: build+deploy
          commands:
            - checkout
            - cache list
            - cache clear
            - cache list
            - sem-version python 3.7
            - pip install -r requirements.txt
            - cache store
            - export TRAVIS_BRANCH=${SEMAPHORE_GIT_BRANCH}
            - export DOCKER_TAG=$(echo $TRAVIS_BRANCH | tr //. _) && echo ${DOCKER_TAG}
            - dockercompose=$(which docker-compose)
            - sudo rm ${dockercompose}
            - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
            - chmod +x docker-compose
            - sudo mv docker-compose ${dockercompose} && docker-compose -v
            - chmod +x ./scripts/build.sh
            - chmod +x ./scripts/deploy.sh
            - gem install kontena-cli -v 1.5 --no-ri --no-rdoc
            - docker login -u="${DOCKER_USER}" -p="${DOCKER_PASSWORD}"
            - ./scripts/build.sh && ./scripts/deploy.sh
      env_vars:
        - name: DOCKER_COMPOSE_VERSION
          value: "1.24.1"
      secrets:
        - name: docker_hub
  - name: Test cache
    task:
      jobs:
        - name: test cache restore
          commands:
            - checkout
            - sem-version python 3.7
            - cache restore
            - pip install -r requirements.txt
